// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id             String      @id @default(uuid())
  typeClient     String      // 'PARTICULIER', 'PROFESSIONNEL', 'ANONYME'
  dateCreation   DateTime    @default(now())
  
  // Contact & Localisation
  email          String?
  telephone      String?
  adresse        String?
  ville          String?
  codePostal     String?
  pointsFidelite Int         @default(0)
  statut         String      @default("INACTIF") // 'ACTIF', 'INACTIF', 'EN_COMPTE', 'DE_PASSAGE'
  commentaires   String?

  // --- Particulier Specific ---
  civilite       String?
  nom            String?
  prenom         String?
  dateNaissance  DateTime?
  typePieceIdentite   String?
  numeroPieceIdentite String?
  cinParent           String?
  
  // Complex Data (JSONB)
  groupeFamille      Json?     // { role: 'Principal'|'Membre', nomFamille: string, lienParental: string }
  dossierMedical     Json?     // Full medical history object
  couvertureSociale  Json?     // { type, numeroAdhesion... }

  // --- Professionnel Specific ---
  raisonSociale      String?
  identifiantFiscal  String?
  ice                String?
  registreCommerce   String?
  patente            String?
  tvaAssujetti       Boolean?  @default(false)
  numeroAutorisation String?   // If TVA assujetti
  siteWeb            String?
  
  // Pro Complex Data
  contacts           Json?     // Array of internal contacts
  convention         Json?     // { actif: boolean, nomConvention... }

  // Relations
  fiches             Fiche[]
  factures           Facture[]
}

model Fiche {
  id           String   @id @default(uuid())
  dateCreation DateTime @default(now())
  statut       String   // 'BROUILLON', 'EN_COURS', 'VALIDE', 'FACTURE', 'LIVRE'
  type         String   // 'MONTURE', 'LENTILLES', 'PRODUIT'
  dateLivraisonEstimee DateTime?
  montantTotal Float    @default(0)
  montantPaye  Float    @default(0)
  
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id])
  
  // The content of the fiche (flexible structure)
  // Stores: ordonnance, monture, verres, lentilles selection, adaptation...
  content      Json 
  
  // Relations
  facture      Facture?
}

model Facture {
  id             String    @id @default(uuid())
  numero         String    @unique // Sequence: FAC-2024-001, DEV-2024-001, etc.
  type           String    // FACTURE, DEVIS, AVOIR, BL
  dateEmission   DateTime  @default(now())
  dateEcheance   DateTime?
  statut         String    // BROUILLON, VALIDE, PAYEE, ANNULEE, PARTIEL
  
  clientId       String
  client         Client    @relation(fields: [clientId], references: [id])
  
  ficheId        String?   @unique
  fiche          Fiche?    @relation(fields: [ficheId], references: [id])

  // Montants (Stored as Float)
  totalHT        Float     @default(0)
  totalTVA       Float     @default(0)
  totalTTC       Float     @default(0)
  resteAPayer    Float     @default(0)
  
  // Arrays storing JSON data
  lignes         Json      // [{ description, qte, prixUnitaireTTC, tva, remise, totalTTC }]
  paiements      Json?     // [{ date, montant, mode, reference }]
  
  // Extras
  montantLettres String?
  notes          String?
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}
