<div class="fiche-container">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="icon-box">
                <mat-icon>remove_red_eye</mat-icon>
            </div>
            <div class="title-section">
                <h1>Fiche Lentilles</h1>
                <p *ngIf="client" style="color: black; opacity: 0.9;">
                    <span style="font-weight: bold; font-size: 1.1em;">{{ clientDisplayName }}</span>
                    <span style="opacity: 0.8; font-size: 0.9em;">
                        <span *ngIf="client.telephone"> ‚Ä¢ üìû {{ client.telephone }}</span>
                        <span *ngIf="client.ville"> ‚Ä¢ üìç {{ client.ville }}</span>
                    </span>
                </p>
            </div>
        </div>
        <div class="header-actions">
            <!-- View Mode: Retour -->
            <button mat-stroked-button (click)="goBack()" *ngIf="!isEditMode">
                <mat-icon>arrow_back</mat-icon> Retour
            </button>

            <!-- Create Mode: Annuler -->
            <button mat-stroked-button (click)="goBack()" *ngIf="isEditMode && (!ficheId || ficheId === 'new')">
                Annuler
            </button>

            <!-- Edit Mode: Annuler -->
            <button mat-stroked-button (click)="toggleEditMode()" *ngIf="isEditMode && ficheId && ficheId !== 'new'">
                Annuler
            </button>

            <!-- View Mode: Modifier -->
            <button mat-raised-button color="primary" (click)="toggleEditMode()"
                *ngIf="!isEditMode && ficheId && ficheId !== 'new'">
                <mat-icon>edit</mat-icon> Modifier
            </button>

            <!-- Edit Mode: Enregistrer -->
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="ficheForm.invalid || loading"
                *ngIf="isEditMode">
                <mat-icon>save</mat-icon> {{ (ficheId && ficheId !== 'new') ? 'Mettre √† jour' : 'Enregistrer' }}
            </button>
        </div>
    </div>

    <form [formGroup]="ficheForm">
        <mat-tab-group [(selectedIndex)]="activeTab" animationDuration="0ms" class="custom-tabs">

            <!-- ONGLET 1: ORDONNANCE -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">description</mat-icon>
                    Ordonnance
                </ng-template>

                <div class="tab-content">
                    <div formGroupName="ordonnance">

                        <!-- Info Prescription -->
                        <mat-card class="section-card mb-4">
                            <mat-card-content class="grid-3">
                                <mat-form-field appearance="outline">
                                    <mat-label>Date de prescription</mat-label>
                                    <input matInput [matDatepicker]="picker" formControlName="datePrescription">
                                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                                    <mat-datepicker #picker></mat-datepicker>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Prescripteur</mat-label>
                                    <input matInput formControlName="prescripteur" placeholder="Dr. Ophtalmologue">
                                    <mat-icon matSuffix>person_medical</mat-icon>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Date de contr√¥le</mat-label>
                                    <input matInput [matDatepicker]="pickerControleAdapt"
                                        formControlName="dateControle">
                                    <mat-datepicker-toggle matIconSuffix
                                        [for]="pickerControleAdapt"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerControleAdapt></mat-datepicker>
                                </mat-form-field>
                            </mat-card-content>
                        </mat-card>

                        <div class="eyes-container">
                            <!-- OD -->
                            <mat-card class="eye-card od-card" formGroupName="od">
                                <div class="eye-header">
                                    <span class="eye-badge">OD</span>
                                    <h3>≈íil Droit</h3>
                                </div>
                                <mat-card-content>
                                    <div class="grid-3">
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Sph√®re</mat-label>
                                            <input matInput formControlName="sphere" placeholder="+0.00">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Cylindre</mat-label>
                                            <input matInput formControlName="cylindre" placeholder="-0.00">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Axe</mat-label>
                                            <input matInput formControlName="axe" placeholder="0¬∞">
                                        </mat-form-field>
                                    </div>
                                    <div class="grid-3">
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Addition</mat-label>
                                            <input matInput formControlName="addition" placeholder="+0.00">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field highlight-field">
                                            <mat-label>K1 (mm)</mat-label>
                                            <input matInput formControlName="k1" placeholder="7.80">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field highlight-field">
                                            <mat-label>K2 (mm)</mat-label>
                                            <input matInput formControlName="k2" placeholder="7.90">
                                        </mat-form-field>
                                    </div>
                                </mat-card-content>
                            </mat-card>

                            <!-- OG -->
                            <mat-card class="eye-card og-card" formGroupName="og">
                                <div class="eye-header">
                                    <span class="eye-badge">OG</span>
                                    <h3>≈íil Gauche</h3>
                                </div>
                                <mat-card-content>
                                    <div class="grid-3">
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Sph√®re</mat-label>
                                            <input matInput formControlName="sphere" placeholder="+0.00">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Cylindre</mat-label>
                                            <input matInput formControlName="cylindre" placeholder="-0.00">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Axe</mat-label>
                                            <input matInput formControlName="axe" placeholder="0¬∞">
                                        </mat-form-field>
                                    </div>
                                    <div class="grid-3">
                                        <mat-form-field appearance="outline" class="dense-field">
                                            <mat-label>Addition</mat-label>
                                            <input matInput formControlName="addition" placeholder="+0.00">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field highlight-field">
                                            <mat-label>K1 (mm)</mat-label>
                                            <input matInput formControlName="k1" placeholder="7.80">
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="dense-field highlight-field">
                                            <mat-label>K2 (mm)</mat-label>
                                            <input matInput formControlName="k2" placeholder="7.90">
                                        </mat-form-field>
                                    </div>
                                </mat-card-content>
                            </mat-card>
                        </div> <!-- End of eyes-container -->
                    </div> <!-- End of ordonnance -->
                </div> <!-- End of tab-content -->
            </mat-tab>

            <!-- ONGLET 2: S√âLECTION LENTILLES -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">shopping_bag</mat-icon>
                    S√©lection Lentilles
                </ng-template>

                <div class="tab-content" formGroupName="lentilles">
                    <!-- Type & Usage -->
                    <mat-card class="section-card mb-4">
                        <mat-card-content>
                            <div class="grid-3 align-center">
                                <mat-form-field appearance="outline">
                                    <mat-label>Type de lentille</mat-label>
                                    <mat-select formControlName="type">
                                        <mat-option *ngFor="let type of lensTypes" [value]="type">{{ type
                                            }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Usage</mat-label>
                                    <mat-select formControlName="usage">
                                        <mat-option *ngFor="let usage of lensUsages" [value]="usage">{{ usage
                                            }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <mat-checkbox formControlName="diffLentilles" color="primary">
                                    Lentilles diff√©rentes OD/OG
                                </mat-checkbox>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <div class="eyes-container">
                        <!-- OD Selection -->
                        <mat-card class="eye-card od-card" formGroupName="od">
                            <div class="eye-header">
                                <span class="eye-badge">OD</span>
                                <h3>Lentille Droite</h3>
                            </div>
                            <mat-card-content>
                                <div class="grid-2">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Marque</mat-label>
                                        <input matInput formControlName="marque" placeholder="Ex: Acuvue">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline">
                                        <mat-label>Mod√®le</mat-label>
                                        <input matInput formControlName="modele" placeholder="Ex: Oasys">
                                    </mat-form-field>
                                </div>
                                <div class="grid-2">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Rayon (BC)</mat-label>
                                        <input matInput formControlName="rayon" placeholder="8.4">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline">
                                        <mat-label>Diam√®tre (DIA)</mat-label>
                                        <input matInput formControlName="diametre" placeholder="14.0">
                                    </mat-form-field>
                                </div>
                                <mat-divider class="mb-3"></mat-divider>
                                <div class="grid-3">
                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Sph√®re</mat-label>
                                        <input matInput formControlName="sphere" placeholder="+0.00">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Cylindre</mat-label>
                                        <input matInput formControlName="cylindre" placeholder="-0.00">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Axe</mat-label>
                                        <input matInput formControlName="axe" placeholder="0¬∞">
                                    </mat-form-field>
                                </div>
                            </mat-card-content>
                        </mat-card>

                        <!-- OG Selection (Conditional or Duplicate) -->
                        <mat-card class="eye-card og-card" formGroupName="og" *ngIf="diffLentilles">
                            <div class="eye-header">
                                <span class="eye-badge">OG</span>
                                <h3>Lentille Gauche</h3>
                            </div>
                            <mat-card-content>
                                <div class="grid-2">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Marque</mat-label>
                                        <input matInput formControlName="marque" placeholder="Ex: Acuvue">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline">
                                        <mat-label>Mod√®le</mat-label>
                                        <input matInput formControlName="modele" placeholder="Ex: Oasys">
                                    </mat-form-field>
                                </div>
                                <div class="grid-2">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Rayon (BC)</mat-label>
                                        <input matInput formControlName="rayon" placeholder="8.4">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline">
                                        <mat-label>Diam√®tre (DIA)</mat-label>
                                        <input matInput formControlName="diametre" placeholder="14.0">
                                    </mat-form-field>
                                </div>
                                <mat-divider class="mb-3"></mat-divider>
                                <div class="grid-3">
                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Sph√®re</mat-label>
                                        <input matInput formControlName="sphere" placeholder="+0.00">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Cylindre</mat-label>
                                        <input matInput formControlName="cylindre" placeholder="-0.00">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Axe</mat-label>
                                        <input matInput formControlName="axe" placeholder="0¬∞">
                                    </mat-form-field>
                                </div>
                            </mat-card-content>
                        </mat-card>

                        <!-- Placeholder if same lenses -->
                        <div class="eye-card og-card opacity-50" *ngIf="!diffLentilles">
                            <div class="eye-header">
                                <span class="eye-badge">OG</span>
                                <h3>Lentille Gauche</h3>
                            </div>
                            <mat-card-content class="flex-center">
                                <p class="text-muted">Identique √† l'≈ìil droit</p>
                            </mat-card-content>
                        </div>
                    </div>
                </div>
            </mat-tab>


            <!-- ONGLET 3: ADAPTATION MODERNE (NOUVEAU) -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">auto_awesome</mat-icon>
                    Adaptation Moderne
                </ng-template>


                <app-adaptation-moderne [formGroup]="$any(ficheForm.get('adaptation'))"
                    (suggestionGenerated)="onSuggestionGenerated($event)">
                </app-adaptation-moderne>
            </mat-tab>


            <!-- ONGLET 4: ADAPTATION (ANCIEN) -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">fact_check</mat-icon>
                    Adaptation
                </ng-template>

                <div class="tab-content adaptation-compact" formGroupName="adaptation">

                    <!-- Dates Section Only -->
                    <mat-card class="dates-card">
                        <div class="card-header">
                            <h3>Dates de Suivi</h3>
                        </div>
                        <mat-card-content>
                            <div class="dates-grid">
                                <mat-form-field appearance="outline">
                                    <mat-label>Date de Pose</mat-label>
                                    <input matInput [matDatepicker]="pickerEssai" formControlName="dateEssai">
                                    <mat-datepicker-toggle matIconSuffix [for]="pickerEssai"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerEssai></mat-datepicker>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Date de Contr√¥le</mat-label>
                                    <input matInput [matDatepicker]="pickerControleFinal"
                                        formControlName="dateControle">
                                    <mat-datepicker-toggle matIconSuffix
                                        [for]="pickerControleFinal"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerControleFinal></mat-datepicker>
                                </mat-form-field>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Clinical Comparison Grid -->
                    <div class="comparison-grid-card">
                        <!-- Grid Header -->
                        <div class="grid-header">
                            <div class="col-label">Param√®tre</div>
                            <div class="col-eye od-col">
                                <span class="eye-badge-mini od-bg">OD</span> ≈íil Droit
                            </div>
                            <div class="col-eye og-col">
                                <span class="eye-badge-mini og-bg">OG</span> ≈íil Gauche
                            </div>
                        </div>

                        <div class="grid-body">
                            <!-- Row: Fr√©quence Cillement -->
                            <div class="grid-row">
                                <div class="row-label">Fr√©quence Cillement</div>
                                <div class="row-control" formGroupName="od">
                                    <mat-button-toggle-group formControlName="frequenceCillement"
                                        class="symmetric-toggle">
                                        <mat-button-toggle value="lent">Lent</mat-button-toggle>
                                        <mat-button-toggle value="normal">Normal</mat-button-toggle>
                                        <mat-button-toggle value="frequent">Fr√©quent</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                                <div class="row-control" formGroupName="og">
                                    <mat-button-toggle-group formControlName="frequenceCillement"
                                        class="symmetric-toggle">
                                        <mat-button-toggle value="lent">Lent</mat-button-toggle>
                                        <mat-button-toggle value="normal">Normal</mat-button-toggle>
                                        <mat-button-toggle value="frequent">Fr√©quent</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                            </div>

                            <!-- Row: Amplitude Cillement -->
                            <div class="grid-row">
                                <div class="row-label">Amplitude Cillement</div>
                                <div class="row-control" formGroupName="od">
                                    <mat-button-toggle-group formControlName="amplitudeCillement"
                                        class="symmetric-toggle">
                                        <mat-button-toggle value="complet">Complet</mat-button-toggle>
                                        <mat-button-toggle value="incomplet">Incomplet</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                                <div class="row-control" formGroupName="og">
                                    <mat-button-toggle-group formControlName="amplitudeCillement"
                                        class="symmetric-toggle">
                                        <mat-button-toggle value="complet">Complet</mat-button-toggle>
                                        <mat-button-toggle value="incomplet">Incomplet</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                            </div>

                            <!-- Row: Tonus Palp√©bral -->
                            <div class="grid-row">
                                <div class="row-label">Tonus Palp√©bral</div>
                                <div class="row-control" formGroupName="od">
                                    <mat-button-toggle-group formControlName="tonusPalpebral" class="symmetric-toggle">
                                        <mat-button-toggle value="fort">Fort</mat-button-toggle>
                                        <mat-button-toggle value="normal">Normal</mat-button-toggle>
                                        <mat-button-toggle value="faible">Faible</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                                <div class="row-control" formGroupName="og">
                                    <mat-button-toggle-group formControlName="tonusPalpebral" class="symmetric-toggle">
                                        <mat-button-toggle value="fort">Fort</mat-button-toggle>
                                        <mat-button-toggle value="normal">Normal</mat-button-toggle>
                                        <mat-button-toggle value="faible">Faible</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                            </div>

                            <!-- Row: R√©action Pupillaire -->
                            <div class="grid-row">
                                <div class="row-label">R√©action Pupillaire</div>
                                <div class="row-control" formGroupName="od">
                                    <mat-button-toggle-group formControlName="reactionPupillaire"
                                        class="symmetric-toggle">
                                        <mat-button-toggle value="rapide">Rapide</mat-button-toggle>
                                        <mat-button-toggle value="normale">Normale</mat-button-toggle>
                                        <mat-button-toggle value="lente">Lente</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                                <div class="row-control" formGroupName="og">
                                    <mat-button-toggle-group formControlName="reactionPupillaire"
                                        class="symmetric-toggle">
                                        <mat-button-toggle value="rapide">Rapide</mat-button-toggle>
                                        <mat-button-toggle value="normale">Normale</mat-button-toggle>
                                        <mat-button-toggle value="lente">Lente</mat-button-toggle>
                                    </mat-button-toggle-group>
                                </div>
                            </div>

                            <!-- Row: S√©cr√©tion -->
                            <div class="grid-row">
                                <div class="row-label">S√©cr√©tion Lacrymale</div>
                                <div class="row-control" formGroupName="od">
                                    <mat-form-field appearance="outline" class="measure-input">
                                        <input matInput type="number" formControlName="secretionLacrimale"
                                            placeholder="0.00">
                                        <span matTextSuffix>mm</span>
                                    </mat-form-field>
                                </div>
                                <div class="row-control" formGroupName="og">
                                    <mat-form-field appearance="outline" class="measure-input">
                                        <input matInput type="number" formControlName="secretionLacrimale"
                                            placeholder="0.00">
                                        <span matTextSuffix>mm</span>
                                    </mat-form-field>
                                </div>
                            </div>

                            <!-- Row: B.U.T -->
                            <div class="grid-row">
                                <div class="row-label">B.U.T</div>
                                <div class="row-control" formGroupName="od">
                                    <mat-form-field appearance="outline" class="measure-input">
                                        <input matInput type="number" formControlName="but" placeholder="0">
                                        <span matTextSuffix>sec</span>
                                    </mat-form-field>
                                </div>
                                <div class="row-control" formGroupName="og">
                                    <mat-form-field appearance="outline" class="measure-input">
                                        <input matInput type="number" formControlName="but" placeholder="0">
                                        <span matTextSuffix>sec</span>
                                    </mat-form-field>
                                </div>
                            </div>

                            <!-- Row: √âtat Paupi√®res -->
                            <div class="grid-row border-none">
                                <div class="row-label">√âtat Paupi√®res</div>
                                <div class="row-control" formGroupName="od">
                                    <mat-form-field appearance="outline" class="text-input">
                                        <input matInput formControlName="etatPaupieres" placeholder="Observations...">
                                    </mat-form-field>
                                </div>
                                <div class="row-control" formGroupName="og">
                                    <mat-form-field appearance="outline" class="text-input">
                                        <input matInput formControlName="etatPaupieres" placeholder="Observations...">
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Remarques & Validation (Footer) -->
                    <div class="footer-section">
                        <mat-form-field appearance="outline" class="remarques-field">
                            <mat-label>Remarques Globales</mat-label>
                            <textarea matInput formControlName="remarques" rows="2"></textarea>
                        </mat-form-field>
                    </div>

                </div>
            </mat-tab>
            <!-- ONGLET 5: FACTURATION -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">euro</mat-icon>
                    Facturation
                </ng-template>
                <div class="tab-content" style="padding: 24px;">
                    <app-facture-form [factureId]="linkedFacture?.id" [embedded]="true"
                        (onSaved)="onInvoiceSaved($event)" [nomenclature]="nomenclatureString"
                        [initialLines]="initialInvoiceLines" [clientIdInput]="clientId" [ficheIdInput]="ficheId">
                    </app-facture-form>
                </div>
            </mat-tab>

            <!-- ONGLET 6: PAIEMENTS -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">payments</mat-icon>
                    Paiements
                </ng-template>
                <div class="tab-content" style="padding: 24px;">
                    <app-payment-list [clientId]="clientId" [ficheId]="ficheId"></app-payment-list>
                </div>
            </mat-tab>

            <!-- ONGLET 7: SUIVI COMMANDE -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">local_shipping</mat-icon>
                    Suivi Commande
                </ng-template>
                <div class="tab-content" formGroupName="suiviCommande" style="padding: 24px;">

                    <!-- Stepper UI -->
                    <div class="mb-4 px-4" style="margin-bottom: 32px;">
                        <div class="relative flex items-center justify-between w-full"
                            style="display: flex; justify-content: space-between; position: relative;">
                            <!-- Connecting Line -->
                            <div
                                style="position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: #e0e0e0; z-index: 0; transform: translateY(-50%);">
                            </div>

                            <!-- Step 1: A Commander -->
                            <div
                                style="z-index: 1; display: flex; flex-direction: column; align-items: center; background: white; padding: 0 10px;">
                                <div [style.background-color]="getStepState('A_COMMANDER') !== 'pending' ? '#1976d2' : '#e0e0e0'"
                                    style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-bottom: 8px;">
                                    1
                                </div>
                                <span [style.color]="getStepState('A_COMMANDER') === 'active' ? '#1976d2' : '#757575'"
                                    style="font-weight: 500;">√Ä Commander</span>
                            </div>

                            <!-- Step 2: Command√© -->
                            <div
                                style="z-index: 1; display: flex; flex-direction: column; align-items: center; background: white; padding: 0 10px;">
                                <div [style.background-color]="getStepState('COMMANDE') !== 'pending' ? '#1976d2' : '#e0e0e0'"
                                    style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-bottom: 8px;">
                                    2
                                </div>
                                <span [style.color]="getStepState('COMMANDE') === 'active' ? '#1976d2' : '#757575'"
                                    style="font-weight: 500;">Command√©</span>
                            </div>

                            <!-- Step 3: Re√ßu -->
                            <div
                                style="z-index: 1; display: flex; flex-direction: column; align-items: center; background: white; padding: 0 10px;">
                                <div [style.background-color]="getStepState('RECU') !== 'pending' ? '#4caf50' : '#e0e0e0'"
                                    style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-bottom: 8px;">
                                    3
                                </div>
                                <span [style.color]="getStepState('RECU') === 'active' ? '#4caf50' : '#757575'"
                                    style="font-weight: 500;">Re√ßu Atelier</span>
                            </div>

                            <!-- Step 4: Livr√© Client -->
                            <div
                                style="z-index: 1; display: flex; flex-direction: column; align-items: center; background: white; padding: 0 10px;">
                                <div [style.background-color]="getStepState('LIVRE_CLIENT') !== 'pending' ? '#9c27b0' : '#e0e0e0'"
                                    style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-bottom: 8px;">
                                    4
                                </div>
                                <span [style.color]="getStepState('LIVRE_CLIENT') === 'active' ? '#9c27b0' : '#757575'"
                                    style="font-weight: 500;">Livr√© Client</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Area -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Left: Status & Actions -->
                        <mat-card class="section-card">
                            <div class="card-header">
                                <h3>Actions & Statut</h3>
                            </div>
                            <mat-card-content>
                                <div style="text-align: center; margin-bottom: 24px;">
                                    <span
                                        style="text-transform: uppercase; font-size: 0.8rem; font-weight: bold; color: #757575; display: block; margin-bottom: 8px;">Statut
                                        Actuel</span>
                                    <div style="font-size: 1.5rem; font-weight: bold;"
                                        [style.color]="suiviStatut === 'A_COMMANDER' ? '#ff9800' : suiviStatut === 'COMMANDE' ? '#1976d2' : suiviStatut === 'RECU' ? '#4caf50' : '#9c27b0'">
                                        {{ suiviStatut === 'A_COMMANDER' ? '√Ä COMMANDER' :
                                        suiviStatut === 'COMMANDE' ? 'EN COMMANDE' :
                                        suiviStatut === 'RECU' ? 'RE√áU ATELIER' : 'LIVR√â CLIENT' }}
                                    </div>
                                </div>

                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button mat-raised-button color="primary" (click)="setOrderStatus('COMMANDE')"
                                        *ngIf="suiviStatut === 'A_COMMANDER'" [disabled]="!isEditMode">
                                        <mat-icon>send</mat-icon> Marquer comme Command√©
                                    </button>

                                    <button mat-raised-button color="accent" (click)="setOrderStatus('RECU')"
                                        *ngIf="suiviStatut === 'COMMANDE'" [disabled]="!isEditMode">
                                        <mat-icon>check_circle</mat-icon> Marquer comme Re√ßu
                                    </button>

                                    <button mat-raised-button style="background-color: #9c27b0; color: white;"
                                        (click)="setOrderStatus('LIVRE_CLIENT')" *ngIf="suiviStatut === 'RECU'"
                                        [disabled]="!isEditMode">
                                        <mat-icon>inventory_2</mat-icon> Marquer comme Livr√© au Client
                                    </button>
                                </div>
                            </mat-card-content>
                        </mat-card>

                        <!-- Right: Details Form -->
                        <mat-card class="section-card">
                            <div class="card-header">
                                <h3>D√©tails Commande</h3>
                            </div>
                            <mat-card-content class="grid-1">
                                <mat-form-field appearance="outline">
                                    <mat-label>Fournisseur Verres</mat-label>
                                    <input matInput formControlName="fournisseur" placeholder="Ex: Hoya, Essilor...">
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>R√©f√©rence Commande</mat-label>
                                    <input matInput formControlName="referenceCommande"
                                        placeholder="N¬∞ de commande fournisseur">
                                </mat-form-field>

                                <div class="grid-2">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Date Commande</mat-label>
                                        <input matInput [matDatepicker]="pickerCmd" formControlName="dateCommande">
                                        <mat-datepicker-toggle matIconSuffix [for]="pickerCmd"></mat-datepicker-toggle>
                                        <mat-datepicker #pickerCmd></mat-datepicker>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Date R√©ception</mat-label>
                                        <input matInput [matDatepicker]="pickerRecu" formControlName="dateReception">
                                        <mat-datepicker-toggle matIconSuffix [for]="pickerRecu"></mat-datepicker-toggle>
                                        <mat-datepicker #pickerRecu></mat-datepicker>
                                    </mat-form-field>
                                </div>

                                <mat-form-field appearance="outline">
                                    <mat-label>Commentaires / Suivi</mat-label>
                                    <textarea matInput formControlName="commentaire" rows="3"></textarea>
                                </mat-form-field>
                            </mat-card-content>
                        </mat-card>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
    </form>
</div>