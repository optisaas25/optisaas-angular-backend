<div class="p-6" [class.h-full]="dialogRef">
    <mat-card class="!shadow-sm !border !border-gray-200">
        <mat-card-header class="mb-6 !flex items-center">
            <div class="flex-1">
                <mat-card-title class="!text-2xl !font-bold">
                    {{ isEditMode ? 'Modifier Facture Fournisseur' : 'Nouvelle Facture Fournisseur' }}
                </mat-card-title>
                <mat-card-subtitle>
                    Enregistrement d'une facture et planification du paiement
                </mat-card-subtitle>
            </div>
            <button mat-icon-button (click)="onCancel()" *ngIf="dialogRef">
                <mat-icon>close</mat-icon>
            </button>
        </mat-card-header>

        <mat-progress-bar mode="indeterminate" *ngIf="submitting"></mat-progress-bar>

        <mat-card-content class="!p-0">
            <mat-stepper #stepper linear="true" animationDuration="0ms">
                <!-- ÉTAPE 1 : DÉTAILS DE LA FACTURE -->
                <mat-step [stepControl]="detailsGroup">
                    <ng-template matStepLabel>Détails de la Facture</ng-template>
                    <div class="p-6">
                        <form [formGroup]="detailsGroup">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <mat-form-field appearance="outline" class="md:col-span-2">
                                    <mat-label>Fournisseur *</mat-label>
                                    <input type="text" placeholder="Sélectionner ou saisir..." matInput
                                        [formControl]="supplierCtrl" [matAutocomplete]="autoSupplier">
                                    <mat-autocomplete #autoSupplier="matAutocomplete" [displayWith]="displayFn"
                                        (optionSelected)="onSupplierChange($event.option.value?.id)">
                                        <mat-option *ngFor="let s of filteredSuppliers | async" [value]="s">
                                            {{ s.nom }}
                                            <span *ngIf="s.ville" class="text-xs text-gray-500"> ({{ s.ville }})</span>
                                        </mat-option>
                                    </mat-autocomplete>
                                    <mat-icon matSuffix class="cursor-pointer" (click)="supplierCtrl.setValue('')"
                                        *ngIf="supplierCtrl.value">close</mat-icon>
                                    <mat-icon matSuffix *ngIf="!supplierCtrl.value">business</mat-icon>
                                    <mat-error
                                        *ngIf="detailsGroup.get('fournisseurId')?.hasError('required') && !supplierCtrl.value">Requis</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Numéro de Facture *</mat-label>
                                    <input matInput formControlName="numeroFacture">
                                    <mat-error
                                        *ngIf="detailsGroup.get('numeroFacture')?.hasError('required')">Requis</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Type de dépense *</mat-label>
                                    <input type="text" placeholder="Sélectionner ou saisir..." matInput
                                        formControlName="type" [matAutocomplete]="auto">
                                    <mat-autocomplete #auto="matAutocomplete">
                                        <mat-option *ngFor="let t of filteredTypes | async" [value]="t">
                                            {{ t }}
                                        </mat-option>
                                    </mat-autocomplete>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Date d'émission *</mat-label>
                                    <input matInput [matDatepicker]="pickerE" formControlName="dateEmission">
                                    <mat-datepicker-toggle matIconSuffix [for]="pickerE"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerE></mat-datepicker>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Date d'échéance </mat-label>
                                    <input matInput [matDatepicker]="pickerH" formControlName="dateEcheance">
                                    <mat-datepicker-toggle matIconSuffix [for]="pickerH"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerH></mat-datepicker>
                                </mat-form-field>
                            </div>

                            <div
                                class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 pt-6 border-t bg-gray-50 p-4 rounded-xl">
                                <mat-form-field appearance="outline">
                                    <mat-label>Total TTC *</mat-label>
                                    <input matInput type="number" formControlName="montantTTC">
                                    <mat-hint>Saisissez le montant TTC</mat-hint>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>TVA (%)</mat-label>
                                    <mat-select formControlName="tauxTVA">
                                        <mat-option [value]="0">0% (Exonéré)</mat-option>
                                        <mat-option [value]="7">7%</mat-option>
                                        <mat-option [value]="10">10%</mat-option>
                                        <mat-option [value]="14">14%</mat-option>
                                        <mat-option [value]="20">20%</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Montant HT</mat-label>
                                    <input matInput type="number" formControlName="montantHT" readonly>
                                    <mat-hint>Calculé automatiquement</mat-hint>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Montant TVA</mat-label>
                                    <input matInput type="number" formControlName="montantTVA" readonly>
                                </mat-form-field>
                            </div>

                            <!-- Pièces jointes -->
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-sm font-semibold text-gray-700">Pièces jointes</h4>
                                    <div class="flex gap-2" *ngIf="!isViewMode">
                                        <button type="button" mat-raised-button color="primary"
                                            (click)="openFileUpload()">
                                            <mat-icon>upload_file</mat-icon>
                                            Importer Files
                                        </button>
                                        <button type="button" mat-raised-button color="accent" (click)="openCamera()">
                                            <mat-icon>photo_camera</mat-icon>
                                            Prendre une photo
                                        </button>
                                    </div>
                                </div>

                                <input #fileInput type="file" accept="image/*,application/pdf" multiple class="hidden"
                                    (change)="onFilesSelected($event)">

                                <!-- Liste des fichiers -->
                                <div *ngIf="attachmentFiles.length > 0" class="space-y-2">
                                    <div *ngFor="let file of attachmentFiles; let i = index"
                                        class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <div class="flex items-center gap-3">
                                            <mat-icon class="text-gray-600">
                                                {{ file.type.startsWith('image/') ? 'image' : 'picture_as_pdf' }}
                                            </mat-icon>
                                            <div>
                                                <a href="javascript:void(0)" (click)="viewFile(file)"
                                                    class="text-blue-600 hover:underline font-medium">
                                                    {{ file.name }}
                                                </a>
                                                <p class="text-xs text-gray-500">{{ formatFileSize(file.size) }}</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button type="button" mat-icon-button (click)="viewFile(file)"
                                                matTooltip="Visualiser">
                                                <mat-icon>visibility</mat-icon>
                                            </button>
                                            <button type="button" mat-icon-button color="warn" (click)="deleteFile(i)"
                                                matTooltip="Supprimer" *ngIf="!isViewMode">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="flex justify-end mt-6">
                            <button mat-raised-button color="primary" matStepperNext [disabled]="detailsGroup.invalid"
                                class="!px-8">
                                Suivant : Planifier Paiement <mat-icon>arrow_forward</mat-icon>
                            </button>
                        </div>
                    </div>
                </mat-step>

                <!-- ÉTAPE 2 : PLANIFICATION DU PAIEMENT -->
                <mat-step [stepControl]="paymentGroup">
                    <ng-template matStepLabel>Planification du Paiement</ng-template>
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold">Échéances de paiement</h3>
                                <p class="text-sm text-gray-500">Total à répartir : <span
                                        class="font-bold text-gray-800">{{ detailsGroup.get('montantTTC')?.value |
                                        number:'1.2-2' }} MAD</span></p>
                            </div>
                            <button mat-stroked-button color="primary" (click)="addEcheance()" *ngIf="!isViewMode">
                                <mat-icon>add</mat-icon> Ajouter une échéance
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div *ngFor="let eg of echeances.controls; let i=index" [formGroup]="$any(eg)"
                                class="p-2 bg-gray-50 border border-gray-100 rounded-lg relative mb-2">
                                <div class="flex justify-between items-center mb-2 border-b pb-1">
                                    <h4 class="text-xs font-bold text-gray-700 uppercase">Échéance #{{i+1}}</h4>
                                    <button mat-icon-button color="warn" (click)="removeEcheance(i)" *ngIf="!isViewMode"
                                        matTooltip="Supprimer l'échéance" class="scale-75">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Mode *</mat-label>
                                        <mat-select formControlName="type">
                                            <mat-option *ngFor="let m of paymentMethods" [value]="m">{{ m
                                                }}</mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Date *</mat-label>
                                        <input matInput [matDatepicker]="pick" formControlName="dateEcheance">
                                        <mat-datepicker-toggle matIconSuffix [for]="pick"></mat-datepicker-toggle>
                                        <mat-datepicker #pick></mat-datepicker>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Montant *</mat-label>
                                        <input matInput type="number" formControlName="montant">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>N° Pièce</mat-label>
                                        <input matInput formControlName="reference" placeholder="N° Chèque/LCN">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="dense-field">
                                        <mat-label>Banque</mat-label>
                                        <input matInput formControlName="banque" placeholder="Nom de la banque">
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="echeances.length === 0"
                            class="text-center p-12 border-2 border-dashed rounded-xl text-gray-400 mb-6">
                            <mat-icon class="!w-12 !h-12 !text-5xl mb-4 opacity-20">payments</mat-icon>
                            <p>Aucune échéance planifiée.</p>
                        </div>

                        <div
                            class="mt-6 flex flex-col md:flex-row justify-between items-center p-6 bg-gray-100 rounded-xl gap-4">
                            <div class="text-lg">
                                Total échéances : <span class="font-bold">{{ totalEcheances | number:'1.2-2' }}
                                    MAD</span>
                            </div>
                            <div class="text-lg" [class.text-red-600]="diffTTC !== 0"
                                [class.text-green-600]="diffTTC === 0">
                                @if (diffTTC > 0) {
                                Reste à affecter : <span class="font-bold">{{ diffTTC | number:'1.2-2' }} MAD</span>
                                } @else if (diffTTC < 0) { Trop perçu : <span class="font-bold">{{ -diffTTC |
                                    number:'1.2-2' }} MAD</span>
                                    } @else {
                                    <mat-icon class="align-middle">check_circle</mat-icon> Le compte est bon
                                    }
                            </div>
                        </div>

                        <div class="flex justify-between mt-8 pt-6 border-t">
                            <button mat-button matStepperPrevious>
                                <mat-icon>arrow_back</mat-icon> Retour aux détails
                            </button>
                            <div class="flex gap-2">
                                <button mat-button (click)="onCancel()">{{ isViewMode ? 'Fermer' : 'Annuler' }}</button>
                                <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="form.invalid"
                                    class="!px-10" *ngIf="!isViewMode">
                                    <mat-icon>save</mat-icon> Enregistrer la facture
                                </button>
                            </div>
                        </div>
                    </div>
                </mat-step>
            </mat-stepper>
        </mat-card-content>
    </mat-card>


    <!-- File Viewer Modal -->
    <div *ngIf="viewingFile" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4"
        (click)="closeViewer()">
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full max-h-[90vh] overflow-auto"
            (click)="$event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">{{ viewingFile.name }}</h3>
                <button type="button" mat-icon-button (click)="closeViewer()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
            <div class="flex justify-center">
                <img *ngIf="viewingFile.type.startsWith('image/')" [src]="viewingFile.preview"
                    class="max-w-full max-h-[70vh] object-contain">
                <iframe *ngIf="viewingFile.type === 'application/pdf'" [src]="viewingFile.preview"
                    class="w-full h-[70vh]"></iframe>
            </div>
        </div>
    </div>
</div>