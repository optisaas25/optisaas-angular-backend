<div class="container">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Trésorerie & Plafonds</h1>
        <div class="flex gap-4">
            <span class="text-gray-500 py-2">Mois: {{currentMonth}}/{{currentYear}}</span>
            <button mat-icon-button (click)="loadData()"><mat-icon>refresh</mat-icon></button>
        </div>
    </div>

    <div *ngIf="loading" class="text-center p-10">Chargement des données...</div>

    <div *ngIf="summary && !loading">
        <div class="grid">
            <mat-card class="card-metric border-l-4 border-blue-500">
                <div class="metric-label">Dépenses Directes</div>
                <div class="metric-value text-blue-600">{{ summary.totalDirectExpenses | number:'1.2-2' }} DH</div>
                <div class="text-xs text-gray-400">Espèces / Carte</div>
            </mat-card>

            <mat-card class="card-metric border-l-4 border-orange-500">
                <div class="metric-label">Échéances Prévues</div>
                <div class="metric-value text-orange-600">{{ summary.totalEcheances | number:'1.2-2' }} DH</div>
                <div class="text-xs text-gray-400">Chèques / LCN</div>
            </mat-card>

            <mat-card class="card-metric border-l-4 border-purple-500">
                <div class="metric-label">Consommation Plafond</div>
                <div class="metric-value" [ngClass]="percentageUsed > 100 ? 'text-red-500' : 'text-purple-600'">
                    {{ summary.totalProjected | number:'1.2-2' }} DH
                </div>
                <div class="threshold-container px-4">
                    <div class="threshold-label">
                        <span>{{ percentageUsed.toFixed(1) }}% du plafond</span>
                        <span>Max: {{ monthlyThreshold | number }} DH</span>
                    </div>
                    <mat-progress-bar [mode]="'determinate'" [value]="percentageUsed"
                        [color]="thresholdColor"></mat-progress-bar>
                </div>
            </mat-card>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <mat-card class="p-4">
                <h3 class="font-bold mb-4">Répartition des Dépenses par Catégorie</h3>
                <div class="chart-container">
                    <canvas #categoryChart></canvas>
                </div>
            </mat-card>

            <mat-card class="p-4 flex flex-col justify-center items-center">
                <mat-icon style="font-size: 64px; width: 64px; height: 64px;"
                    color="primary">health_and_safety</mat-icon>
                <h3 class="font-bold mt-4">Santé Financière</h3>
                <div class="text-center text-gray-500 p-4">
                    {{ percentageUsed > 100 ? 'Attention: Vous avez dépassé votre plafond mensuel !' :
                    percentageUsed > 80 ? 'Vigilance: Vous approchez de votre plafond mensuel.' :
                    'Tout est sous contrôle. Votre trésorerie est saine.' }}
                </div>
            </mat-card>
        </div>
    </div>
</div>