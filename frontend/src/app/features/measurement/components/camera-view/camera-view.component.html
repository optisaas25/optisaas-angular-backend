<div class="camera-container">
    <div class="video-wrapper">
        <video #videoElement autoplay playsinline muted class="video-element"></video>
        <canvas #overlayCanvas width="1280" height="720" class="overlay-canvas" (mousedown)="onMouseDown($event)"
            (mousemove)="onMouseMove($event)" (mouseup)="onMouseUp()" (mouseleave)="onMouseUp()">
        </canvas>

        @if (!isReady) {
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Chargement du systÃ¨me de dÃ©tection...</p>
        </div>
        }
    </div>

    <div class="controls-panel">
        <div class="calibration-section">
            <h3>ğŸ“ Calibration</h3>

            @if (!isCalibrated) {
            <div class="calibration-instructions">
                <p class="instruction-title">ğŸ¯ Calibration Rapide</p>
                <ol class="instruction-list">
                    <li>Portez vos lunettes</li>
                    <li>Regardez la camÃ©ra bien en face</li>
                    <li>Entrez la largeur de votre monture (mm)</li>
                    <li>Cliquez "Calibrer"</li>
                </ol>
            </div>

            <div class="input-group">
                <label for="frameWidth">Largeur monture (mm)</label>
                <input type="number" id="frameWidth" [(ngModel)]="frameWidthMm" placeholder="ex: 140"
                    class="form-control" />
                <small class="help-text">Largeur totale de la monture (gÃ©nÃ©ralement 130-150mm)</small>
            </div>

            <button (click)="calibrateWithFrame()" [disabled]="!frameWidthMm || frameWidthMm <= 0"
                class="btn-calibrate">
                âœ“ Calibrer avec Monture
            </button>
            } @else {
            <div class="calibration-status success">
                âœ“ CalibrÃ©: {{ pixelsPerMm?.toFixed(2) }} px/mm
                <button (click)="resetCalibration()" class="btn-reset">ğŸ”„ Recalibrer</button>
            </div>
            }
            <!-- Capture / Validate Controls -->
            <div class="capture-controls" style="margin-top: 20px; display: flex; gap: 10px;">
                @if (!isCaptured) {
                <button (click)="captureImage()" class="btn-capture"
                    style="flex: 1; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 4px;">
                    ğŸ“¸ Figer l'image (Ajustement)
                </button>
                } @else {
                <button (click)="retake()" class="btn-retake"
                    style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 4px;">
                    âŒ Reprendre
                </button>
                }
            </div>

            @if (isCaptured) {
            <div class="instruction-box"
                style="margin-top: 10px; background: #e3f2fd; padding: 10px; border-radius: 4px;">
                <p><strong>ğŸ‘† Ajustement Hauteur :</strong></p>
                <p>DÃ©placez les lignes bleues sur le bas de la monture.</p>
            </div>
            }

        </div>

        <div class="measurements-section">
            <h3>ğŸ“Š Mesures</h3>
            @if (latestMeasurement) {
            <div class="measurement-item">
                <span class="label">PD Total:</span>
                <span class="value">{{ latestMeasurement.pdMm.toFixed(1) }} mm</span>
            </div>
            <div class="measurement-item">
                <span class="label">PD Gauche:</span>
                <span class="value">{{ latestMeasurement.pdLeftMm.toFixed(1) }} mm</span>
            </div>
            <div class="measurement-item">
                <span class="label">PD Droit:</span>
                <span class="value">{{ latestMeasurement.pdRightMm.toFixed(1) }} mm</span>
            </div>
            } @else {
            <p class="no-data">Aucune mesure disponible</p>
            }
        </div>
    </div>
</div>